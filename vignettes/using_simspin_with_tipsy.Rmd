---
title: "Using SimSpin v2.8.4a to process Tipsy format outputs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using SimSpin v2.8.4a: Tipsy files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The purpose of this vignette is to allow a user to explore the range of possible outputs that can be produced by SimSpin for a tipsy formatted input file from the Gasoline code. Because the Gasoline code is sparsely documented, we provide this branch of the code (v2.8.4a) as a seperate branch `dev-tipsy` that will not be merged with `main`.

In the example below, you will need to enter the file location of your own tipsy Gasoline output galaxy such that this can be run through the code. The rest of the functions *should* then run without modification. Set the location of your simulation input file below:

```{r}
f = "~/Downloads/Tipsy_out/GLX.01100"#"PATH/TO/YOUR/OUTPUT"
```

The purpose of the SimSpin R-package is to take a particle simulation of a galaxy and produce a spectral data cube in the style of a specified Integral Field Spectroscopy (IFS) instrument. 

In this vignette, we will take you through the process of constructing such a data cube from an input tipsy file. This is a simple process comprised of three steps:

  1. Read in your particle data and produce the relevant spectra using the `make_simspin_file` function.
  1. Setup the observation by defining your `telescope` and `observing_strategy`.
  1. Build your data cube using the `build_datacube`.

From this spectral data cube, observable properties can be measured using standard observational pipelines, such as pPXF. You can see another long-form example [here](https://kateharborne.github.io/SimSpin/examples/fitting_spectra_with_pPXF.html) demonstrating how the kinematics can be fit using the spectral data cube. 

--------------------------------------------------------------------------------

# Step 0: Installing SimSpin (the compatible version)

The `dev-tipsy` branch of SimSpin is (currently) the only one that supports the reading of tipsy files.
To install a specific branch of the package, we can use the following:

```{r setup}
library(devtools)
install_github("kateharborne/SimSpin", ref="dev-tipsy")
# this points towards the specific branch of the code

library(SimSpin)
packageVersion("SimSpin")
```

Ensure that the package version of the loaded code is "v2.8.4.1" as this is the version that includes support for tipsy output files from the Gasoline code.

--------------------------------------------------------------------------------

# Step 1: Importing the Gasoline simulation files

To begin a SimSpin observation, we begin by converting the input simulation into a consistent format. This step creates an R-formatted file that is intended to be universal in structure (to aid in comparing between different simulations) and to allow efficient repeat observations of the same system due to the construction of the file. It is a pre-processing step that allows the user to smooth the gas distribution (in the scenario that the softening lengths of the gas is significantly larger than the spaxel size of the intended observation) and pre-computes the assignment of stellar particles to particular stellar templates.

For Gasoline outputs, you should have your outputs formatted in a directory that contains the output simulation in one named binary file in tipsy format, along with several additional extension files (e.g. `*.timeform`, `*.iord`, `*.massform`, etc.). If you place the parameter file used to build the simulation in the same directory, this information will also be used to format the SimSpin object, else expected defaults for required parameters will be substituted and the user will be warned that this is the case. 

If you do not have the parameter file in the output directory, you should see a warning issued when teh following code chunk is run. Else, it should proceed without warnings raised. 

**Be aware that the speed at which this chunk will execute will scale with the size of the simulation. For a file containing ~9x10^6 particles (stellar and gas) will take ~10 min to run this initial `make_simspin_file` function, though later data cube construction steps should then be faster. I'd suggest going and getting a coffee! **

```{r}
tipsy_output = list.files(dirname(f), full.names = T)

if (any(stringr::str_detect(tipsy_output, ".param"))){
  print("Values of Star Formation Efficiency set in the parameter file included in this directory will be used for SimSpin.")
} else {
  print("No parameter file included in this directory. Default value of Star Formation Efficiency (0.1 SFR/Msol_gas) will be used for SimSpin.")
}

### Making a SimSpin file using this input tipsy file ------------------------
tipsy_simspin_file = 
    SimSpin::make_simspin_file(filename = f,
                               template = "BC03lr",
                               write_to_file = F, 
                               cores = 1)

```
This SimSpin file can then be used to produce an observation. We can inspect the information included in this file as well:

```{r}
names(tipsy_simspin_file) # this will tell you what groups are contained within the file

tipsy_simspin_file$header # inspecting the header information of the 
```

To smooth the gas distribution in an SPH model, we would set the input parameter `sph_spawn_n` to a value greater than 1. This will spawn **n** particles for each gas particle scaled in their mass and sampling SPH kernel in random uniform position within the smoothing length of that gas particle. Again, depending on the comparative resolution of the simulation to the spatial resolution of the intended telescope, this smoothing may not be necessary for visualisation. Obviously, this process of spawning particles will increase the size of the SimSpin file produced. 

--------------------------------------------------------------------------------

# Step 2: Making observations from SimSpin files
 
First, initialise a telescope and observing strategy:

```{r}
MUSE = SimSpin::telescope(type="MUSE", fov = 5)
strategy = SimSpin::observing_strategy(dist_z = 0.05, inc_deg=70, blur=F)
```

Further examples of supported instruments, or how to define your own, can be found online: https://kateharborne.github.io/SimSpin/basic_usage/

An observation can then be made using `build_datacube`. This will be a stellar kinematic observation, with stellar properties summarised. By changing the `method` parameter, this can be modified to create an observation of the gas (or star-forming gas where SFR > 0).

```{r}
observed_tipsy_cube = build_datacube(simspin_file = tipsy_simspin_file,
                                     telescope = MUSE,
                                     observing_strategy = strategy,
                                     method = "velocity", 
                                     write_fits = F)
```

This file will contain a number of images. To construct a spectral data cube (in which you will then need to run pPXF to derive observed kinematics and stellar population parameters), simply switch `method = "spectral"`.

The same kind of observation can also be made for the gas component of the galaxy:
```{r}
observed_tipsy_cube_gas = build_datacube(simspin_file = tipsy_simspin_file,
                                         telescope = MUSE,
                                         observing_strategy = strategy,
                                         method = "gas", 
                                         write_fits = F)
```

This file will contain another set of images for the gas component. We summarise some of the other assumptions made for the output Gasoline parameters in the section below and point the user to the lines in the SimSpin package where the specific values have been computed (for bug-fixing in the future)!

--------------------------------------------------------------------------------

# Step 3: Considering the results 

## For a stellar observation

In the `read_files.R` file, you will find the `.read_tipsy` file at line 134. This function contains the methods we use to convert the information contained within the Gasoline output files into the output summary images.

```{r}

plot_flux(observed_tipsy_cube$observed_images$flux_image)

```

For computing fluxes, we have used:
- stellar ages
- stellar metallicities 
- stellar initial masses

These are used to map to the grid of stellar templates in the chosen template library (in this case, the Bruzal and Charlot 2003 templates).

We've assumed that the output stellar ages given in the `.timeform` file output can be converted to stellar ages in the following way:

```{r, eval=FALSE}
# This chunk should not run in the example, but we copy the code used to compute the stellar ages here. This can be found on line 245 in the read_files.R file:

  if (file.exists(paste0(f,".timeform"))){
    age_data = file(paste0(f,".timeform"), "rb")
    stars_formed = readBin(age_data, "numeric", n = nstar, size = 4, endian = endian) # time since the start of the simulation, given in Myr
    close(age_data)

    stars_formed = stars_formed*1e-3 # formation time of stars in Gyrs
    stars_age = (9.427098) - stars_formed # since time now (at z=0, age of the Universe in Gyr assuming Plank cosmology)
    
    remove(stars_formed)
  }

```

Similarly, that initial masses of stars are given in the `.massform` file output, which we map to initial masses as follows:

```{r, eval=FALSE}
# This chunk should not run in the example, but we copy the code used to compute the stellar initial masses here. This can be found on line 255 in the read_files.R file:

  if (file.exists(paste0(f,".massform"))){
    mass_data = file(paste0(f,".massform"), "rb")
    stars_mass_formed = readBin(mass_data, "numeric", n = nstar, size = 4, endian = endian)
    close(mass_data)

    stars_mass_formed = stars_mass_formed*1e10 # initial mass in Msol
  }

```

## For a gas observation 

```{r}

plot_SFR(observed_tipsy_cube_gas$observed_images$SFR_image)

```
Behaviour of gas in SimSpin is treated in lines 169 - 201, as copied below. We have used treatments from pynbody to compute the mass fractions of different elements, the mean molecular mass given the gas temperature and hence the level of dispersion due to thermal effects in the gas. These are also copied below for consideration:

```{r, eval = FALSE}
# This chunk should not run in the example, but we copy the code used to compute gas properties here. This can be found on lines 169-201 in the read_files.R file:

    # Helium mass fraction including correction based on metallicity, from
    # https://pynbody.github.io/pynbody/_modules/pynbody/snapshot/tipsy.html
    hetot = 0.236 + (2.1 * gas_part$Metallicity)
    # Hydrogen mass fraction including correction based on metallicity, from
    # https://pynbody.github.io/pynbody/_modules/pynbody/snapshot/tipsy.html
    gas_part$Hydrogen = 1.0 - gas_part$Metallicity - hetot
    gas_part$ID = 1:ngas

    #mean molecular mass, i.e. the mean atomic mass per particle
    mu = numeric(length = ngas)
    mu[gas_part$Temperature <= 1e4] = 0.59
    mu[gas_part$Temperature > 1e4] = 1.3

    #Gas internal energy derived from temperature
    gas_part$InternalEnergy = gas_part$Temperature / (mu *((5/3) - 1))
    gas_part$ThermalDispersion = sqrt((gas_part$InternalEnergy)*(.adiabatic_index - 1))

    #star formation rate, computed based on the SFE and gas mass

    if (any(stringr::str_detect(list.files(dirname(f)), ".param"))){

      param = read.delim(list.files(dirname(f), full.names = T)[stringr::str_detect(list.files(dirname(f)), ".param")],
                         blank.lines.skip = T, sep = "=", comment.char = "#")

      sfe = as.numeric(param[which(stringr::str_detect(param$achInFile, "dCStar")), 2])
      remove(param)

    } else {
      sfe = 0.1
      warning("Unable to find parameter file. Assuming Star Formation Efficiency = 0.1 SFR/Msol_gas. \n Add your parameter file `*.param` to the same directory as the output to read this value successfully from the input. \n")
    }

    gas_part$SFR = gas_part$Mass * sfe

```

In the case that these assumed parameters are incorrect, please reach out to katherine.harborne@uwa.edu.au (or fork your own copy of this branch and push any changes to the dev-tipsy branch on this repo!)
